# 1 引言

## 1.1  编写目的
  本文档用于规范数据库设计、开发等方面的内容。
## 1.2  预期读者
本文档的预期读者为本项目组全体成员，以及其他与项目有关的管理人员。
## 1.3  术语定义
OMP：Operation Management Platform

## 1.4  参考文档
《数据库编码规范.pdf》

# 2 数据库规范
## 2.1  设计规范
### 2.1.1  命名规范
数据库对象的命名规则的范围为管理平台设计开发所涉及的表，对于其他外部系统所创建的表不在本规范约束范围内，
数据库对象如表、列、序列、过程、函数等在命名时要遵循如下规则：
* 命名要使用富有意义中文名称缩写，要以字母开头，不能超过30个字符。
* 数据库对象名称由如下部分组成：范围、类型、名称实体，各词汇间采用“_”连接。
* 其中各数据库对象的范围和类型的具体含义及取值详见各数据库对象的命名规则。
* 数据库对象的名称不允许是数据库的 **保留字** 和 **关键字**。

<table>
    <tr>
        <th>数据库对象</th>
        <th>格式</th>
        <th>样例</th>
        <th>说明</th>
    </tr>
    <tr>
        <td>表</td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>订单表</td>
        <td><范围(可缩写)>_<类型(t OR v OR mv)>_<表名(可缩写)></td>
        <td>pro_t_orders</td>
        <td>其中 pro 代表所属模块为产品，t 为表单类型,orders 为表单名称</td>
    </tr>
    <tr>
        <td>索引</td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>普通索引</td>
        <td>IDX_<表名>_N<序号></td>
        <td>IDX_PRO_T_ORDERS_N1</td>
        <td>PRO_T_ORDERS表第一个普通索引</td>
    </tr>
    <tr>
        <td>位图索引</td>
        <td>IDX_<表名>_B<序号></td>
        <td>IDX_PRO_T_ORDERS_B1</td>
        <td>PRO_T_ORDERS表第一个位图索引</td>
    </tr>
    <tr>
        <td>唯一索引</td>
        <td>IDX_<表名>_U<序号></td>
        <td>IDX_PRO_T_ORDERS_U1</td>
        <td>PRO_T_ORDERS表第一个唯一索引</td>
    </tr>
    <tr>
        <td>视图</td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>订单普通视图表</td>
        <td><范围(可缩写)>_<类型(t OR v OR mv)>_<表名(可缩写)></td>
        <td>pro_v_orders</td>
        <td>其中 pro 代表所属模块为产品，t 为表单view类型,orders 为表单名称</td>
    </tr>
    <tr>
        <td>其他对象</td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>存储过程</td>
        <td>P_<存储过程名称></td>
        <td>P_GET_SYSDATE</td>
        <td>获取系统时间</td>
    </tr>
    <tr>
        <td>函数</td>
        <td>F_<函数名称></td>
        <td>F_GET_ORDER_TYPE_COMMENT</td>
        <td>根据编码转换字典表对应订单类型中文名称</td>
    </tr>
    <tr>
        <td>包</td>
        <td>PKG_<包名称></td>
        <td>PKG_PRINT</td>
        <td>打印</td>
    </tr>
    <tr>
        <td>主键</td>
        <td>PK_<表名></td>
        <td>PK_PRO_T_ORDERS</td>
        <td></td>
    </tr>
    <tr>
        <td>外键</td>
        <td>FK_<表名>_<序号></td>
        <td>FK_PRO_T_ORDERS_1</td>
        <td></td>
    </tr>
    <tr>
        <td>序列</td>
        <td>SEQ_<序列名称></td>
        <td>SEQ_REGISTER_NUMBER</td>
        <td>受理编号序列</td>
    </tr>
    <tr>
        <td>别名信息类型定义</td>
        <td><用户名>_<表名></td>
        <td></td>
        <td></td>
    </tr>
</table>

### 2.1.2  表规范
#### 2.1.2.1  建表的参数设计
* 不允许将表建立在默认系统表空间上
* 表和索引建立在不同表空间上
* 建表时必须指明所存储的表空间
* 生成表脚本时非空的列放在表的前部，可空的列放在表的后部
* 数据缓冲池的类型：查询频繁且数据量较少的参数表 采用 buffer pool keep
* INITIAL: 对初始化数据量大的表，设置的值要大于初始化数据
* PARALLEL: 对于OLTP\(联机事务处理\)系统，不允许使用该参数

#### 2.1.2.2  主外键设计
* 数据约束优先考虑利用数据库提供的约束机制，在数据库产品所提供的机制无法满足的情况下，再考虑通过编程实现
* 主键的设置通常不使用实际意义的列做主键，具体情况应结合业务特性综合考虑
* 字表在外键的字段上必须建立索引
* 由Sequence产生的ID列，不作为组合PK的列
* 删除约束时使用keep index参数

#### 2.1.2.3  列设计
* 定长字符类型列使用CHAR类型，最大长度为2000；不定长字符类型列使用VARCHAR类型，最大长度为4000
* 日期字段需定义为DATE类型。如果定义为VARCHAR或者CHAR时需要进行转换，影响效率。需要数据精确到微秒的字段定义为TIMESTAMP类型
* 列表为null时，需要定义default值，避免因为null而造成索引不能被用到的情况
* 使用NUMBER类型是必须指定长度。由NUMBER的到精度与密度来保障数据的一致性
* 表中字段的命名长度不应该超过30个字节
* 记录数达到千万级的表，必须进行分区，分区一般遵循以下原则：
   >1. 数据具有明显的范围属性，比如日期，大小等，且经常进行范围条件查询的表，采用范围分区。
   >2. 数据具有明显的列表属性，比如地点，省份等，且经常用列表条件查询的表，采用列表分区。
   >3. 数据不具有明显的范围属性或者列表属性，且数据量很大，则可以采用hash分区。

#### 2.1.2.4  临时表
* 对于只对本事务有效的临时表使用ON COMMIT DELETE ROWS关键字创建该表
* 对于只对本会话有效的临时表使用ON COMMIT PRESERVE ROWS 关键字建该表
* 对于临时表空间要求比较大的业务系统，临时表要存储在独立的表空间中，并且临时表空间的数据文件需要放在独立的磁盘上

### 2.1.3  索引规范
* 选择使用普通B树索引
* 小表\(数据量小于10000条记录为标准\)不需要建立索引
* 创建或重建索引时需指定使用NOLOGGING子句，提高执行效率
对于分区索引，建全局分区或者本地分区规则如下：

![分区规则图](https://raw.githubusercontent.com/houfengtai/vue-express-mongo/master/demonstration/sylc.png)
* 建立分区索引必须指定表空间，并且指定的表空间要与数据表空间分开。
* 对于OLTP应用的业务系统，单个表上索引的个数不超过5个
* 将记录差别数最多的列放在索引顺序的最前面
* 对于OLTP应用的业务系统索引数据的重复率尽量不超过20%
* 进行order by column desc 排序时，创建column desc索引
* 频繁使用的index需要放入库缓存的keep池中

### 2.1.4  存储过程、函数、包规范
* 存储过程、函数和包中不允许频繁使用DDL语句
* 存储过程、函数和包中必须有相应的出错处理功能
* 存储过程、函数和包中变量在引用表字段的时候，使用%rowtype类型

### 2.1.5  别名
* 对于只读用户，必须创建与表相同名字的别名
* 别名的访问顺序：public别名 -> private别名 -> 与表同名的对象

### 2.1.6  Database Link 别名
* 只允许从其它数据库中查询少量数据时使用dblink
* 不使用dblink更新其它数据库的数据

## 开发规范
### 2.2.1 变量命名规范
变量的命名体现其作用域和数据类型，规则如下：
* <变量作用域>\_<有意义的变量名字>\_<变量类型>\_<后缀>
* 变量名不能超过数据库限制\(30个字符\)
* 供别的文件或函数调用的函数，不能使用全局变量交换数据
<table>
    <tr>
        <th>项目</th>
        <th>格式</th>
        <th>说明</th>
    </tr>
    <tr>
        <td>全局变量</td>
        <td>Gv_变量名称_变量类型</td>
        <td></td>
    </tr>
    <tr>
        <td>局部变量</td>
        <td>Lv_变量名称_变量类型</td>
        <td></td>
    </tr>
    <tr>
        <td>常量</td>
        <td>C_常量名称_常量类型</td>
        <td></td>
    </tr>
    <tr>
        <td>光标</td>
        <td>Gr_光标名称_光标类型</td>
        <td></td>
    </tr>
    <tr>
        <td>参数 1</td>
        <td>P_参数名称_参数类型</td>
        <td>一般参数</td>
    </tr>
    <tr>
        <td>参数 2</td>
        <td>P_column_name</td>
        <td>与数据库表中列对应的参数和变量</td>
    </tr>
    <tr>
        <td>数组</td>
        <td>数组名称_ary</td>
        <td></td>
    </tr>
    <tr>
        <td>记录</td>
        <td>记录名称_rec</td>
        <td></td>
    </tr>
    <tr>
        <td>COLLECTION</td>
        <td>名称_coll</td>
        <td></td>
    </tr>
</table>

### 2.2.2  SQL开发规范
#### 2.2.2.1 SQL书写规范
* 每行不能写超过80个字符
* 使用两个空格缩进代码，比如：
```sql
BEGIN
  FOR l_count IN 1..10 LOOP
    x_result := x_result + l_count;
  END LOOP;
END;

```

